<div class="modal-overlay" [class.visible]="isModalVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Tạo đoạn chat mới</h2>
      <button class="close-btn" (click)="closeModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="search-section">
        <div class="search-bar">
          <i class="fa fa-search search-icon"></i>
          <input
            #searchInput
            type="text"
            [(ngModel)]="query"
            (ngModelChange)="onSearchChange()"
            placeholder="Tìm kiếm người dùng..."
          />
        </div>
        @if (isLoading) {
        <div class="loading-indicator">Đang tìm kiếm...</div>
        } @if (searchResults.length > 0 && !isLoading) {
        <ul class="user-list">
          @for (user of searchResults; track user) {
          <li class="user-item">
            <div class="user-info">
              <img
                [src]="user.avatarUrl || avatarUrlDefault"
                alt="Avatar"
                class="user-avatar"
              />
              <div class="user-details">
                <span class="user-display-name">{{ user.displayName }}</span>
                <span class="user-email">{{ user.email }}</span>
              </div>
            </div>
            <button
              class="add-btn"
              [disabled]="isSelected(user)"
              (click)="addParticipant(user)"
            >
              {{ isSelected(user) ? "Đã thêm" : "Thêm" }}
            </button>
          </li>
          }
        </ul>
        }
      </div>

      <div class="selected-participants-section">
        <h3>
          Người tham gia đã chọn
          <span class="participant-count"
            >({{ selectedParticipants.length }})</span
          >
        </h3>
        @if (selectedParticipants.length > 0) {
        <div class="selected-list">
          @for (user of selectedParticipants; track user) {
          <div class="selected-user-pill">
            <img
              [src]="user.avatarUrl || avatarUrlDefault"
              alt="Avatar"
              class="selected-avatar"
            />
            <span class="selected-name">{{ user.displayName }}</span>
            <button class="remove-btn" (click)="removeParticipant(user)">
              <i class="fa fa-times"></i>
            </button>
          </div>
          }
        </div>
        } @if (isGroupChat()) {
        <div class="group-name-input">
          <!-- Ô nhập tên nhóm -->
          <input
            type="text"
            [(ngModel)]="groupName"
            placeholder="Đặt tên nhóm..."
          />
          <!-- Avatar Preview + nút chọn file -->
          <div class="avatar-upload">
            <label class="avatar-label">
              @if (fileAvatarPreview) {
              <img
                [src]="fileAvatarPreview"
                alt="Group Avatar"
                class="avatar-preview"
              />
              } @else {
              <div class="avatar-placeholder">+</div>
              }
              <input
                type="file"
                accept="image/png, image/jpeg"
                (change)="onFileSelected($event)"
                hidden
              />
            </label>
            <span class="avatar-text">{{
              fileAvatarName ?? "Chọn ảnh nhóm"
            }}</span>
          </div>
        </div>
        }
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Hủy</button>
      <button
        class="btn btn-primary"
        [class.loading]="isCreatingNewChat"
        [disabled]="isCreateButtonDisabled()"
        (click)="createChat()"
      >
        {{ isCreatingNewChat ? "Đang tạo..." : "Tạo chat" }}
      </button>
    </div>
  </div>
</div>

<div class="exercise-details-container">
  <app-breadcrumb></app-breadcrumb>

  <div class="exercise-details-content">
    <!-- Vế trái: Thông tin bài tập -->

    <div class="exercise-info">
      <div class="header">
        <img
          class="avatar"
          [src]="avatarUrl ? avatarUrl : avatarUrlDefault"
          alt="Avatar"
        />
        <div class="info-main">
          <h2>{{ exercise.title }}</h2>
          <div class="author">
            <i class="fa fa-user"></i>
            <span>{{ authorName }}</span>
          </div>
        </div>
        <div class="actions">
          <button class="icon-btn" title="Sửa" (click)="openUpdateExercise()">
            <i class="fa fa-edit"></i>
          </button>
          <button class="icon-btn" title="Xóa" (click)="openConfirmDelete()">
            <i class="fa fa-trash"></i>
          </button>
          <button
            class="icon-btn"
            title="Thêm câu hỏi"
            (click)="openAddNewQuestion()"
          >
            <i class="fa fa-plus"></i>
          </button>
        </div>
      </div>

      <div class="meta">
        <span class="badge" title="Loại bài tập">
          <i
            class="fa"
            [ngClass]="
              exercise.exerciseType === 'QUIZ'
                ? 'fa-book'
                : 'fa-solid fa-file-code'
            "
          ></i>
          {{ exercise.exerciseType }}
        </span>
        <span
          class="badge difficulty-badge"
          [ngClass]="exercise.difficulty"
          title="Độ khó"
        >
          <span *ngFor="let star of difficultyStars">
            <i
              class="fa"
              [ngClass]="
                star <= difficultyLevel ? 'fa-star' : 'fa-regular fa-star'
              "
            ></i>
          </span>
          <span class="difficulty-label">
            {{
              exercise.difficulty === "EASY"
                ? "Dễ"
                : exercise.difficulty === "MEDIUM"
                ? "Trung bình"
                : exercise.difficulty === "HARD"
                ? "Khó"
                : exercise.difficulty
            }}
          </span>
        </span>
        <span
          class="badge"
          *ngIf="exercise.orgId; else publicBadge"
          title="Nội bộ"
        >
          <i class="fa fa-building"></i> Nội bộ
        </span>
        <ng-template #publicBadge>
          <span class="badge" title="Công khai">
            <i class="fa fa-globe"></i> Công khai
          </span>
        </ng-template>
        <span class="badge" title="Trạng thái">
          <i
            class="fa"
            [ngClass]="exercise.visibility ? 'fa-users' : 'fa-user-lock'"
          ></i>
          {{ exercise.visibility ? "Tất cả" : "Chỉ định" }}
        </span>
      </div>

      <div class="details">
        <p>{{ exercise.description }}</p>
      </div>

      <div class="tags">
        <i class="fa fa-tags"></i>
        <span *ngFor="let tag of exercise.tags.slice(0, 3)" class="tag"
          >#{{ tag }}</span
        >
        <span *ngIf="exercise.tags.length > 3" class="tag"
          >+{{ exercise.tags.length - 3 }}</span
        >
      </div>

      <div class="time-info">
        <i class="fa fa-clock-o"></i>
        <span *ngIf="exercise.startTime">
          {{ exercise.startTime | date : "dd/MM/yyyy HH:mm" }} -
          {{ exercise.endTime | date : "dd/MM/yyyy HH:mm" }}
        </span>
      </div>

      <div class="stats">
        <span title="Số câu hỏi"
          ><i class="fa fa-question-circle"></i>
          {{ exercise.quizDetail?.totalElements ?? 0 }}</span
        >
        <span title="Thời lượng"
          ><i class="fa fa-hourglass-half"></i>
          {{ exercise.duration }} phút</span
        >
        <span title="Giá"
          ><i class="fa fa-money"></i> ${{ exercise.cost }}</span
        >
      </div>

      <div class="btn-container">
        <button class="btn main" *ngIf="hasQuestions" (click)="doingQuiz()">
          <i class="fa fa-play"></i> Bắt đầu
        </button>
        <button class="btn other" (click)="goBack()">
          <i class="fa fa-arrow-left"></i> Quay lại
        </button>
        <button
          class="btn other"
          *ngIf="hasQuestions"
          (click)="openAssignExercise()"
        >
          <i class="fa-solid fa-business-time"></i> Giao bài tập
        </button>
      </div>
    </div>

    <!-- Vế phải: Danh sách câu hỏi -->
    <div class="exercise-questions">
      <div class="questions-list">
        <div
          *ngFor="let q of exercise.quizDetail?.questions; let i = index"
          class="question-item"
        >
          <div class="question-header">
            <span class="question-index">Câu {{ i + 1 }}</span>
            <div class="type-quiz">
              Loại:
              <span class="type-label">
                {{
                  q.type === "MULTI_CHOICE"
                    ? "Nhiều lựa chọn"
                    : q.type === "SINGLE_CHOICE"
                    ? "Một lựa chọn"
                    : q.type === "FILL_BLANK"
                    ? "Điền chỗ trống"
                    : q.type
                }}
              </span>
            </div>
            <div class="btn-control">
              <button
                class="edit-icon-btn"
                title="Chỉnh sửa"
                (click)="toggleDropdown(i)"
              >
                <span><i class="fa fa-edit"></i></span>
              </button>
              <button
                class="edit-icon-btn"
                title="Xóa câu hỏi"
                (click)="toggleConfirmDelete(i)"
              >
                <span><i class="fa fa-trash"></i></span>
              </button>
            </div>
            <div
              class="edit-dropdown"
              *ngIf="openDropdownIndex === i"
              [@dropdownAnimation]
            >
              <ul>
                <li
                  *ngIf="exercise.quizDetail?.questions?.[i]"
                  (click)="onEditQuestion(i, exercise.quizDetail?.questions?.[i])"
                >
                  <i class="fa fa-pen"></i> Sửa câu hỏi
                </li>
                <li
                  *ngIf="exercise.quizDetail?.questions?.[i]"
                  (click)="onAddOption(i, exercise.quizDetail?.questions?.[i]?.id)"
                >
                  <i class="fa fa-plus"></i> Thêm đáp án
                </li>
              </ul>
            </div>
            <div
              class="edit-dropdown"
              *ngIf="opentDeleteConfirm === i"
              [@dropdownAnimation]
            >
              <ul>
                <li
                  *ngIf="exercise.quizDetail?.questions?.[i] as question"
                  (click)="onDeleteQuestion(exercise.id, question.id)"
                >
                  <i class="fa fa-check"></i> Xác nhận xóa
                </li>
              </ul>
            </div>
          </div>
          <div class="question-title">{{ q.text }}</div>
          <div class="question-content">(Điểm: {{ q.points }})</div>
          <div class="question-options">
            <div
              *ngFor="let opt of q.options; let j = index"
              class="option"
              [class.correct]="opt.correct"
            >
              <span class="option-label">{{ getOptionLabel(j) }}.</span>
              {{ opt.optionText }}
              <span *ngIf="opt.correct" class="correct-icon" title="Đáp án đúng"
                ><i class="fa fa-check"></i
              ></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-add-new-question
  (submitQuestion)="onSubmitQuestion($event)"
  [resetLoading]="resetLoadingFlag"
  [isOpen]="isOpenAddNewQuestion"
  (cancel)="cancelAddNew()"
>
</app-add-new-question>

<app-add-new-option
  [isOpen]="isOpenAddNewOption"
  (cancel)="cancelAddNewOption()"
  (submitOption)="onSubmitOption($event)"
>
</app-add-new-option>

<app-update-exercise
  [isOpen]="isOpenUpdateExercise"
  (cancel)="cancelUpdateExercise()"
  [exercise]="exercise"
  (updateSuccess)="onUpdateExercise()"
>
</app-update-exercise>

<app-update-question-option
  [isOpen]="isUpdateQuestion"
  [exerciseId]="exerciseId ?? ''"
  [question]="selectedQuestion"
  (updateSuccess)="onUpdateQuestionSuccess()"
  (cancel)="closeUpdateModal()"
></app-update-question-option>

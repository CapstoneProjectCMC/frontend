<div class="coding-details-container" *ngIf="exercise">
  <div class="problem-description">
    <div class="header-info">
      <h1 class="title">{{ exercise.title }}</h1>
      <div class="header">
        <img
          class="avatar"
          [src]="avatarUrl ? avatarUrl : avatarUrlDefault"
          alt="Avatar"
        />
        <div class="info-main">
          <div class="author">
            <i class="fa fa-user"></i>
            <span>{{ authorName }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="meta-header">
      <span
        class="difficulty-badge"
        [ngClass]="'difficulty-' + exercise.difficulty.toLowerCase()"
      >
        {{ exercise.difficulty }}
      </span>
      <span class="status-tag" *ngIf="exercise.active">
        <i class="fa fa-circle"></i> Hoạt động
      </span>
    </div>

    <div class="section">
      <h2 class="section-title">Mô tả bài toán</h2>
      <p [innerHTML]="exercise.description"></p>
    </div>

    <div class="section">
      <h2 class="section-title">Định dạng đầu vào (Input)</h2>
      <pre><code>{{ exercise.codingDetail.input }}</code></pre>
    </div>

    <div class="section">
      <h2 class="section-title">Định dạng đầu ra (Output)</h2>
      <pre><code>{{ exercise.codingDetail.output }}</code></pre>
    </div>

    <div class="section">
      <h2 class="section-title">Các ràng buộc (Constraints)</h2>
      <pre><code>{{ exercise.codingDetail.constraintText }}</code></pre>
    </div>

    <div class="section">
      <h2 class="section-title">Ví dụ (Sample Test Cases)</h2>
      <div
        *ngFor="let testCase of getSampleTestCases(); let i = index"
        class="test-case"
      >
        <h3 class="test-case-title">
          {{ testCase.sample ? "Ví dụ" : "Mẫu ẩn" }} {{ i + 1 }}
        </h3>
        <div class="io-block">
          <label>Input:</label>
          <pre><code>{{ testCase.input }}</code></pre>
        </div>
        <div class="io-block">
          <label>Output:</label>
          <pre><code>{{ testCase.expectedOutput }}</code></pre>
        </div>
        <p class="note" *ngIf="testCase.note">
          <strong>Giải thích:</strong> {{ testCase.note }}
        </p>
      </div>
    </div>
  </div>

  <aside class="problem-info">
    <div class="info-card">
      <ul class="info-list">
        <li>
          <span><i class="fa fa-clock"></i> Giới hạn thời gian</span>
          <strong>{{ exercise.codingDetail.timeLimit }}s</strong>
        </li>
        <li>
          <span><i class="fa fa-memory"></i> Giới hạn bộ nhớ</span>
          <strong>{{ exercise.codingDetail.memoryLimit }} MB</strong>
        </li>
        <li>
          <span><i class="fa fa-upload"></i> Lượt nộp tối đa</span>
          <strong>{{ exercise.codingDetail.maxSubmissions }}</strong>
        </li>
        <li>
          <span><i class="fa fa-hourglass-half"></i> Thời gian làm bài</span>
          <strong>{{ exercise.duration }} phút</strong>
        </li>
      </ul>
    </div>

    <div class="info-card">
      <h3 class="card-title">Ngôn ngữ được phép</h3>
      <div class="tags-container">
        <span
          *ngFor="let lang of exercise.codingDetail.allowedLanguages"
          class="language-tag"
        >
          {{ lang }}
        </span>
      </div>
    </div>

    <div class="info-card">
      <h3 class="card-title">Tags</h3>
      <div class="tags-container">
        <span *ngFor="let tag of exercise.tags" class="tag">#{{ tag }}</span>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-secondary" (click)="goBack()" title="Quay lại">
        <i class="fa-solid fa-arrow-left"></i>
      </button>

      <div class="admin-actions">
        <div class="dropdown">
          <button
            class="btn btn-warning dropdown-toggle"
            (click)="toggleDropdown()"
            title="Chỉnh sửa"
          >
            <i class="fa-solid fa-pencil"></i>
          </button>

          <ul class="dropdown-menu" [class.show]="isDropdownOpen">
            <li (click)="openBasicEdit()">
              <i class="fa fa-pen-to-square"></i> Chỉnh sửa cơ bản
            </li>
            <li (click)="openDetailEdit()">
              <i class="fa fa-code"></i> Chỉnh sửa chi tiết
            </li>
          </ul>
        </div>
        <button
          class="btn btn-outline-delete"
          (click)="openWarningModal()"
          title="Xóa bài tập này"
        >
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </div>

      <button
        class="btn btn-primary"
        (click)="confirmCoding()"
        title="Bắt đầu làm bài"
      >
        <i class="fa-solid fa-play"></i>
        <span>Bắt đầu làm</span>
      </button>
    </div>
  </aside>
</div>

<div class="loading" *ngIf="!exercise"></div>

<!-- Update Modal -->
<app-update-code-details
  [codingDetail]="exercise?.codingDetail || null"
  [isVisible]="isUpdateModalVisible"
  [exerciseId]="exerciseId"
  (closeModal)="closeUpdateModal()"
  (saveChanges)="onSaveCodingDetails($event)"
></app-update-code-details>

<app-update-exercise
  [isOpen]="isOpenUpdateExercise"
  (cancel)="this.isOpenUpdateExercise = false"
  [exercise]="exerciseBasic"
  (updateSuccess)="onUpdateExercise()"
>
</app-update-exercise>

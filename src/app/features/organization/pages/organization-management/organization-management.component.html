<div class="org-page">
  <div class="header">
    <h2>Quản lý Tổ chức</h2>
    <div class="header-actions">
      <div class="search-bar">
        <input
          type="text"
          [formControl]="searchControl"
          placeholder="Tìm kiếm theo tên, email..."
        />
      </div>
      <!-- Nút tải file mẫu -->
      <button class="btn secondary other" (click)="downloadTemplate()">
        <i class="fa-solid fa-arrow-down"></i>
        Tải file mẫu
      </button>

      <!-- Nút import Excel -->
      <label class="btn primary">
        <i class="fas fa-arrow-up-from-bracket"></i>
        <p>Import Excel</p>
        <input
          type="file"
          accept=".xlsx,.xls"
          (change)="onImportExcel($event)"
          hidden
        />
      </label>

      <button class="btn primary other" (click)="openCreateModal()">
        <i class="fa-solid fa-plus"></i> Thêm tổ chức
      </button>
    </div>
  </div>

  @if (loading) {
  <div class="loading">Đang tải dữ liệu...</div>
  } @if (!loading && !orgs.length) {
  <div class="no-data">
    <ng-lottie [options]="lottieOptions" style="width: 200px; height: 200px">
    </ng-lottie>
    <p>Không tìm thấy tổ chức nào.</p>
  </div>
  } @if (!loading && orgs.length) {
  <div class="org-list">
    @for (org of orgs; track org) {
    <div class="org-card">
      <div class="card-header">
        <div class="card-title">
          @if (org.logoUrl) {
          <img [src]="org.logoUrl" class="logo" />
          } @else {
          <div class="logo-placeholder">
            {{ org.name.charAt(0).toUpperCase() }}
          </div>
          }
          <h4>{{ org.name }}</h4>
        </div>
        <div class="card-actions">
          <span class="status-badge" [ngClass]="org.status.toLowerCase()">
            {{ org.status }}
          </span>
          <button class="btn-icon danger" (click)="confirmDelete(org.id)">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <p class="description">{{ org.description || "Không có mô tả." }}</p>
        <div class="info-grid">
          <div class="info-item">
            <strong><i class="fa fa-envelope"></i> Email:</strong>
            <span>{{ org.email }}</span>
          </div>
          <div class="info-item">
            <strong><i class="fa fa-phone"></i> Điện thoại:</strong>
            <span>{{ org.phone }}</span>
          </div>
          <div class="info-item">
            <strong><i class="fa fa-users"></i> Tổng thành viên:</strong>
            <span>{{ getTotalMembers(org) }}</span>
          </div>
        </div>
        @if (org.blocks.data.length) {
        <div class="blocks-section">
          <strong>Các khối:</strong>
          <div class="blocks-list">
            @for (block of org.blocks.data; track block) {
            <span class="block-tag">
              {{ block.name }} ({{ block.members.totalElements }})
            </span>
            }
          </div>
        </div>
        }
      </div>
      <div class="card-footer">
        <small>Ngày tạo: {{ org.createdAt | date : "dd/MM/yyyy" }}</small>
        <button class="btn secondary" (click)="goToOrganization(org.id)">
          Xem chi tiết
        </button>
      </div>
    </div>
    }
  </div>
  }

  <!-- Modal Confirm Delete -->
  @if (showDeleteConfirm) {
  <div class="modal-backdrop" (click)="showDeleteConfirm = false"></div>
  } @if (showDeleteConfirm) {
  <div class="modal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Xác nhận xóa?</h3>
      <p>Bạn có chắc chắn muốn xóa tổ chức này?</p>
      <div class="actions">
        <button class="btn" (click)="showDeleteConfirm = false">Hủy</button>
        <button class="btn danger" (click)="deleteOrg()">Xóa</button>
      </div>
    </div>
  </div>
  } @if (!loading && orgs.length) {
  <app-pagination
    [currentPageIndex]="page"
    [totalData]="totalData"
    [amountDataPerPage]="size"
    (onPageChange)="loadNextPage($event)"
  ></app-pagination>
  }
</div>

<app-organization-create-modal
  [visible]="showCreateModal"
  (closed)="closeCreateModal()"
  (submitted)="submitCreate($event)"
></app-organization-create-modal>
